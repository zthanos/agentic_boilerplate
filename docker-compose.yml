services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: agentic_boilerplate_web
    working_dir: /app
    ports:
      - "4080:4000"
    extra_hosts:
      - "localhost:host-gateway"
    env_file:
      - ./.env
    environment:
      MIX_ENV: dev
      PHX_SERVER: "true"
      PHX_BIND_IP: "0.0.0.0"
      PORT: "4000"
      LANG: C.UTF-8

      DB_ADAPTER: "postgres"
      DATABASE_URL: "ecto://postgres:postgres@agentic_boilerplate_db:5432/agent_web_dev"

    depends_on:
      agentic_boilerplate_db:
        condition: service_healthy

    volumes:
      - .:/app:cached
      - mix_deps:/app/deps
      - mix_build:/app/_build
      - hex_cache:/root/.hex
      - mix_cache:/root/.mix

    command: >
      sh -lc '
        set -e
        mix local.hex --force
        mix local.rebar --force
        mix deps.get
        mix compile
        cd apps/agent_web
        mix setup
        mix phx.server
      '

    tty: true
    stdin_open: true

  agentic_boilerplate_db:
    image: pgvector/pgvector:pg16
    container_name: agentic_boilerplate_postgres
    environment:
      POSTGRES_DB: agent_web_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    # Αν θέλεις να συνδέεσαι από host, άλλαξε το αριστερό port (π.χ. 55432)
    ports:
      - "15432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d agent_web_dev"]
      interval: 5s
      timeout: 5s
      retries: 20

volumes:
  mix_deps:
  mix_build:
  hex_cache:
  mix_cache:
  pg_data:
