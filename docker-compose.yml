services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: agentic_boilerplate_web
    working_dir: /app
    ports:
      - "4080:4000"
    extra_hosts:
      - "host.docker.internal:host-gateway"      
    environment:
      MIX_ENV: dev
      PHX_SERVER: "true"
      PHX_BIND_IP: "0.0.0.0"
      PORT: "4000"
      # Προαιρετικά: για σταθερό locale/encoding σε logs
      LANG: C.UTF-8
    volumes:
      # Source code (umbrella)
      - .:/app:cached
      # Mix/Hex caches για ταχύτητα
      - mix_deps:/app/deps
      - mix_build:/app/_build
      - hex_cache:/root/.hex
      - mix_cache:/root/.mix
      # Persist SQLite dev DB (agent_web)
      #- sqlite_data:/app/apps/agent_web/priv/repo
    command: >
      sh -lc '
        set -e
        mix local.hex --force
        mix local.rebar --force
        mix deps.get
        mix compile
        cd apps/agent_web
        mix setup
        mix phx.server
      '

    # Αν θες εύκολο shell attach: docker compose exec web sh
    tty: true
    stdin_open: true

volumes:
  mix_deps:
  mix_build:
  hex_cache:
  mix_cache:
  # sqlite_data:
